<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>AI æŠ•ç ”åŠ©æ‰‹ V3 (æ–°è¯„åˆ†æ¨¡å‹)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      /* æ ¸å¿ƒè‰²æ¿ */
      --bg-app: #020617;
      --bg-sidebar: #0f172a;
      --bg-card: #1e293b;
      --bg-input: #020617;
      
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --text-dim: #64748b;

      --accent: #38bdf8;
      --accent-hover: #0ea5e9;
      --accent-dim: rgba(56, 189, 248, 0.1);
      
      --border: #334155;
      
      /* è¯­ä¹‰è‰² */
      --color-good: #22c55e;
      --color-mid: #eab308;
      --color-bad: #ef4444;
      
      /* åœ†è§’ & é—´è· */
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-app);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden; /* App æ¨¡å¼ */
      display: flex;
      flex-direction: column;
    }

    /* --- å¸ƒå±€æ¡†æ¶ --- */
    .app-header {
      height: 60px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-sidebar);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      flex-shrink: 0;
    }
    
    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: -0.5px;
    }
    .logo-dot {
      width: 10px;
      height: 10px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 0 12px var(--accent);
    }

    .app-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* --- å·¦ä¾§ä¾§è¾¹æ  --- */
    .sidebar {
      width: 320px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    .sidebar-toolbar {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .search-input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 8px 12px;
      border-radius: var(--radius-md);
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }

    .category-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 16px 0;
      overflow-x: auto;
      scrollbar-width: none; /* Firefox */
    }
    .category-tabs::-webkit-scrollbar { display: none; }
    
    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 6px 0;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      white-space: nowrap;
    }
    .tab-btn.active {
      color: var(--accent);
      font-weight: 500;
    }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0; 
      right: 0;
      height: 2px;
      background: var(--accent);
    }

    .report-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .list-item {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 4px;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .list-item:hover {
      background: rgba(255,255,255,0.03);
    }
    .list-item.active {
      background: rgba(56, 189, 248, 0.08);
      border-color: rgba(56, 189, 248, 0.2);
    }
    
    .item-main { flex: 1; overflow: hidden; }
    .item-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      color: var(--text-main);
    }
    .item-meta {
      font-size: 12px;
      color: var(--text-dim);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* åˆ†æ•°å¾½ç«  */
    .score-badge-mini {
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 99px;
      min-width: 36px;
      text-align: center;
    }
    .score-high { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .score-mid  { background: rgba(234, 179, 8, 0.15); color: #facc15; }
    .score-low  { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .score-none { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }

    /* --- å³ä¾§è¯¦æƒ…åŒº --- */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px 48px;
      background: radial-gradient(circle at top right, #1e293b 0%, #020617 40%);
    }
    .container-limit {
      max-width: 900px;
      margin: 0 auto;
      padding-bottom: 60px;
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-dim);
      font-size: 14px;
    }

    /* --- è¯¦æƒ…é¡µç»„ä»¶æ ·å¼ --- */
    
    /* 1. Hero Header */
    .hero-header {
      margin-bottom: 32px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 24px;
    }
    .hero-top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .hero-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .ticker-pill {
      font-size: 14px;
      font-weight: 500;
      background: rgba(255,255,255,0.1);
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: 6px;
      vertical-align: middle;
    }
    .tagline-box {
      display: inline-block;
      background: rgba(56, 189, 248, 0.1);
      color: var(--accent);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      margin-top: 8px;
    }
    .hero-links {
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .hero-links a { 
      color: var(--text-muted); 
      text-decoration: none; 
      border-bottom: 1px dotted var(--text-dim); 
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .hero-links a:hover { color: var(--accent); border-color: var(--accent); }

    /* 2. Focus Card */
    .focus-card {
      background: linear-gradient(to right, rgba(56, 189, 248, 0.08), rgba(56, 189, 248, 0.02));
      border-left: 4px solid var(--accent);
      border-radius: 0 8px 8px 0;
      padding: 20px 24px;
      margin-bottom: 32px;
    }
    .focus-title {
      color: var(--accent);
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .focus-list {
      margin: 0;
      padding-left: 20px;
    }
    .focus-list li {
      margin-bottom: 6px;
      color: #e2e8f0;
      font-size: 15px;
      line-height: 1.6;
    }

    /* 3. é›·è¾¾å›¾æ ·å¼ - ä¼˜åŒ–å°ºå¯¸å’Œæ ‡ç­¾ */
    .radar-container {
      position: relative;
      width: 100%;
      height: 400px; /* å¢å¤§é«˜åº¦ */
      margin: 20px 0;
    }

    .radar-canvas {
      width: 100%;
      height: 100%;
    }

    .radar-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .score-explanation {
      margin-top: 20px;
      font-size: 14px;
      color: var(--text-main);
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.2);
      padding: 16px;
      border-radius: 8px;
      font-weight: 500;
    }

    /* 4. Text Content Blocks - æ”¹è¿›æ ·å¼ */
    .content-section { 
      margin-bottom: 32px; 
      padding: 20px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    .content-section:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(56, 189, 248, 0.1);
    }
    
    /* AI è¯„åˆ†åŒºåŸŸç‰¹å®šæ ·å¼ - æ·±è‰²èƒŒæ™¯ */
    .ai-score-section {
      background-color: #0f172a !important;
    }
    
    .ai-score-section:hover {
      background-color: #0f172a !important;
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(56, 189, 248, 0.1);
    }
    
    /* --- æŒ‰é’®æ ·å¼ --- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-main);
      transition: all 0.2s;
    }
    .btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #0b1120;
    }
    .btn-primary:hover { background: var(--accent-hover); color: #000; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-icon-only { padding: 6px; }

    /* å†…è”ç¼–è¾‘æŒ‰é’® */
    .edit-inline {
      opacity: 0.6;
      transition: opacity 0.2s;
      padding: 2px 4px !important;
      font-size: 12px !important;
      background: transparent !important;
      border: 1px solid transparent !important;
    }
    .edit-inline:hover {
      opacity: 1;
      background: rgba(56, 189, 248, 0.1) !important;
      border-color: var(--accent) !important;
    }

    /* PDFä¸‹è½½æŒ‰é’®æ ·å¼ */
    .pdf-download-btn {
      background: linear-gradient(135deg, #dc2626, #ef4444) !important;
      border-color: #dc2626 !important;
    }
    .pdf-download-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #b91c1c, #dc2626) !important;
      border-color: #b91c1c !important;
      color: #fff !important;
    }

    /* --- Modal é€šç”¨ --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(2px);
    }
    .modal-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 500px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      max-height: 85vh;
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
    }
    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* è¡¨å•æ§ä»¶ */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
    .form-input, .form-textarea, .form-select {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      color: var(--text-main);
      font-size: 14px;
      font-family: inherit;
    }
    .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(0,0,0,0.3);
    }
    .form-textarea { min-height: 80px; resize: vertical; }

    /* ç¼–è¾‘æ¨¡å¼æ ·å¼ä¿®æ­£ */
    .edit-grid {
      display: grid;
      gap: 16px;
    }
    .alert-box {
      background: rgba(234, 179, 8, 0.1);
      border: 1px solid rgba(234, 179, 8, 0.2);
      color: #fde047;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 20px;
    }

    /* æ–‡ä»¶ä¸Šä¼ æ ·å¼ */
    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-md);
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }

    .file-upload-area:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.05);
    }

    .file-upload-area.dragover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }

    .file-input {
      display: none;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.7;
    }

    .upload-text {
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--text-dim);
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
  </style>
</head>
<body>

<header class="app-header">
  <div class="logo-area">
    <div class="logo-dot"></div>
    <span>AI æŠ•ç ”åŠ©æ‰‹ V3 (æ–°è¯„åˆ†æ¨¡å‹)</span>
  </div>
  <div style="display:flex; gap:12px;">
    <button class="btn" id="navBtnPrompt">+ ç”Ÿæˆ Prompt</button>
    <button class="btn" id="navBtnImport">â¬‡ å¯¼å…¥æŠ¥å‘Š</button>
  </div>
</header>

<div class="app-body">
  <aside class="sidebar">
    <div class="sidebar-toolbar">
      <input id="searchInput" class="search-input" placeholder="æœç´¢é¡¹ç›®..." />
    </div>
    
    <div class="category-tabs" id="categoryTabs">
      </div>
    
    <div style="padding: 12px 16px 4px; display:flex; justify-content:space-between; align-items:center;">
      <span style="font-size:12px; color:var(--text-dim);">é¡¹ç›®åˆ—è¡¨</span>
      <div style="display: flex; gap: 8px; align-items: center;">
        <select id="sortSelect" style="background:transparent; border:none; color:var(--text-dim); font-size:12px; cursor:pointer;">
          <option value="updated">æŒ‰æ—¶é—´</option>
          <option value="score">æŒ‰åˆ†æ•°</option>
        </select>
        <button class="btn-icon-only edit-inline" onclick="openCategoryManage()" title="ç®¡ç†åˆ†ç±»" style="font-size: 12px;">âš™ï¸</button>
      </div>
    </div>

    <div class="report-list" id="reportList">
      </div>
  </aside>

  <main class="main-content" id="mainScroll">
    <div class="container-limit">
      <div id="detailContainer">
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom:16px; opacity:0.2;">ğŸ“‚</div>
          <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡¹ç›®æŸ¥çœ‹è¯¦æƒ…</p>
          <p style="font-size:12px; opacity:0.6;">æˆ–è€…ç‚¹å‡»é¡¶éƒ¨æŒ‰é’®å¯¼å…¥æ–°æŠ¥å‘Š</p>
        </div>
      </div>
    </div>
  </main>
</div>

<div id="modalPrompt" class="modal-backdrop">
  <div class="modal-panel">
    <div class="modal-header">
      <span>ç”Ÿæˆ AI æç¤ºè¯</span>
      <button class="btn btn-icon-only" onclick="closeModal('modalPrompt')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">é¡¹ç›®åç§° *</label>
        <input id="pName" class="form-input" placeholder="ä¾‹å¦‚ï¼šAURA" />
      </div>
      <div class="form-group">
        <label class="form-label">Ticker *</label>
        <input id="pTicker" class="form-input" placeholder="ä¾‹å¦‚ï¼šAURA / æ— " />
      </div>
      <div class="edit-grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">å®˜ç½‘ (é€‰å¡«)</label>
          <input id="pWeb" class="form-input" />
        </div>
        <div class="form-group">
          <label class="form-label">X (é€‰å¡«)</label>
          <input id="pTw" class="form-input" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">è¡¥å……èµ„æ–™ / å¤‡æ³¨</label>
        <textarea id="pNote" class="form-textarea" placeholder="ç²˜è´´ç›¸å…³é“¾æ¥æˆ–ç®€è¦ä»‹ç»..."></textarea>
      </div>
      
      <div class="form-group" style="margin-top:20px;">
        <label class="form-label">ç”Ÿæˆçš„ Prompt (é¢„è§ˆ)</label>
        <textarea id="pOutput" class="form-textarea" style="height:100px; font-family:monospace; font-size:12px;" readonly></textarea>
      </div>
      <div id="pMsg" style="font-size:12px; margin-top:8px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary btn" id="btnGenPrompt">ç”Ÿæˆå¹¶å¤åˆ¶</button>
    </div>
  </div>
</div>

<div id="modalImport" class="modal-backdrop">
  <div class="modal-panel">
    <div class="modal-header">
      <span>å¯¼å…¥ JSON æŠ¥å‘Š</span>
      <button class="btn btn-icon-only" onclick="closeModal('modalImport')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="alert-box" style="background:rgba(56,189,248,0.1); border-color:rgba(56,189,248,0.2); color:#bae6fd;">
        æ”¯æŒç›´æ¥ç²˜è´´JSONå†…å®¹æˆ–ä¸Šä¼ JSONæ–‡ä»¶
      </div>
      
      <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('jsonFileInput').click()">
        <div class="upload-icon">ğŸ“</div>
        <div class="upload-text">ç‚¹å‡»é€‰æ‹©JSONæ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
        <div class="upload-hint">æ”¯æŒ .json æ ¼å¼æ–‡ä»¶</div>
        <input type="file" id="jsonFileInput" class="file-input" accept=".json" onchange="handleFileSelect(event)">
      </div>
      
      <div style="text-align: center; margin: 16px 0; color: var(--text-dim);">æˆ–</div>
      
      <div class="form-group">
        <label class="form-label">ç›´æ¥ç²˜è´´ JSON å†…å®¹</label>
        <textarea id="importText" class="form-textarea" style="height:200px; font-family:monospace;" placeholder='{ "project_name": ... }'></textarea>
      </div>
      <div id="importMsg" style="font-size:12px;"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" id="btnImportParse">è§£æå¹¶ä¸‹ä¸€æ­¥</button>
    </div>
  </div>
</div>

<div id="modalCategory" class="modal-backdrop">
  <div class="modal-panel" style="max-width:400px;">
    <div class="modal-header">
      <span>é€‰æ‹©å½’æ¡£åˆ†ç±»</span>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">åˆ†ç±»</label>
        <select id="catSelect" class="form-select"></select>
      </div>
      <div class="form-group" id="newCatGroup" style="display:none;">
        <label class="form-label">æ–°åˆ†ç±»åç§°</label>
        <input id="newCatInput" class="form-input" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('modalCategory')">å–æ¶ˆ</button>
      <button class="btn-primary btn" id="btnConfirmImport">ç¡®è®¤ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="modalHistory" class="modal-backdrop">
  <div class="modal-panel">
    <div class="modal-header">
      <span>ç‰ˆæœ¬å†å²</span>
      <button class="btn btn-icon-only" onclick="closeModal('modalHistory')">âœ•</button>
    </div>
    <div class="modal-body" id="historyList"></div>
  </div>
</div>

<div id="modalLaunchpad" class="modal-backdrop">
  <div class="modal-panel" style="max-width: 400px;">
    <div class="modal-header">
      <span>ç¼–è¾‘ Launchpad ä¿¡æ¯</span>
      <button class="btn btn-icon-only" onclick="closeModal('modalLaunchpad')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Launchpad å¹³å°</label>
        <input id="launchpadInput" class="form-input" placeholder="ä¾‹å¦‚ï¼šBinance Launchpad, CoinList ç­‰" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('modalLaunchpad')">å–æ¶ˆ</button>
      <button class="btn-primary btn" onclick="saveLaunchpad()">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="modalCategoryManage" class="modal-backdrop">
  <div class="modal-panel" style="max-width: 500px;">
    <div class="modal-header">
      <span>ç®¡ç†åˆ†ç±»</span>
      <button class="btn btn-icon-only" onclick="closeModal('modalCategoryManage')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="alert-box">
        æç¤ºï¼šåˆ é™¤åˆ†ç±»ä¸ä¼šåˆ é™¤é¡¹ç›®ï¼Œç›¸å…³é¡¹ç›®å°†ç§»åŠ¨åˆ°"å…¶ä»–"åˆ†ç±»
      </div>
      
      <div class="form-group">
        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input id="newCategoryName" class="form-input" placeholder="æ–°åˆ†ç±»åç§°" style="flex: 1;" />
          <button class="btn btn-primary" onclick="addNewCategory()">æ·»åŠ åˆ†ç±»</button>
        </div>
      </div>
      
      <div id="categoryList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px;">
        </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal('modalCategoryManage')">å®Œæˆ</button>
    </div>
  </div>
</div>

<script>
  // ============================================
  // 1. æ•°æ®é€»è¾‘ (LocalStorage Logic)
  // ============================================
  const KEY_REPORTS = 'ai-invest-reports-v1';
  const KEY_CATS = 'ai-invest-categories-v1';

  let reports = [];
  let categories = [];
  
  // è¿è¡Œæ—¶çŠ¶æ€
  let currentReportId = null;
  let currentCatFilter = 'ALL';
  let currentSort = 'updated';
  let pendingImportData = null;
  let isEditing = false;

  function loadData() {
    try {
      const r = localStorage.getItem(KEY_REPORTS);
      reports = r ? JSON.parse(r) : [];
      const c = localStorage.getItem(KEY_CATS);
      if (c) {
        // ä¿®å¤ï¼šåŸç‰ˆä»£ç å¯èƒ½æ²¡æœ‰åœ¨localStorageä¸­ä¿å­˜ categories æ•°ç»„æœ¬èº«
        const parsedC = JSON.parse(c);
        categories = parsedC.categories || parsedC; 
      } else {
        categories = [
          { id: 'ICM', name: 'ICM' }, 
          { id: 'AI', name: 'AI' }, 
          { id: 'DeFi', name: 'DeFi' },
          { id: 'å…¶ä»–', name: 'å…¶ä»–' }
        ];
      }
    } catch(e) { console.error(e); }
  }
  
  function saveData() {
    localStorage.setItem(KEY_REPORTS, JSON.stringify(reports));
  }
  function saveCats() {
    // ç¡®ä¿ä»¥ { categories: [] } ç»“æ„ä¿å­˜ï¼Œæ–¹ä¾¿å°†æ¥æ‰©å±•
    localStorage.setItem(KEY_CATS, JSON.stringify({ categories }));
  }

  function getReport(id) { return reports.find(r => r.id === id); }
  function getContent(report) { 
    return report.versions.find(v => v.version === report.current_version)?.content; 
  }

  function genId() { return 'id-' + Math.random().toString(36).slice(2, 9); }
  
  // Modal Utils
  function openModal(id) { 
    const el = document.getElementById(id);
    if (el) { el.style.display = 'flex'; }
  }
  
  function closeModal(id) { 
    const el = document.getElementById(id);
    if (el) { el.style.display = 'none'; }
  }

  // Debounce Utility (ç”¨äºæœç´¢æ¡†ä¼˜åŒ–)
  function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        func.apply(this, args);
      }, delay);
    };
  }

  // ============================================
  // 2. UI æ¸²æŸ“é€»è¾‘
  // ============================================

  // 2.1 æ¸²æŸ“å·¦ä¾§åˆ†ç±»
  const elCatTabs = document.getElementById('categoryTabs');
  function renderTabs() {
    elCatTabs.innerHTML = '';
    const sortedCats = [...categories].sort((a,b)=>{
      if (a.id==='qita' && b.id!=='qita') return 1;
      if (b.id==='qita' && a.id!=='qita') return -1;
      return String(a.name).localeCompare(String(b.name));
    });
    const all = [{ id: 'ALL', name: 'å…¨éƒ¨' }, ...sortedCats];
    all.forEach(c => {
      const btn = document.createElement('button');
      btn.className = `tab-btn ${c.id === currentCatFilter ? 'active' : ''}`;
      btn.textContent = c.name;
      btn.onclick = () => {
        currentCatFilter = c.id;
        renderTabs();
        renderList();
      };
      elCatTabs.appendChild(btn);
    });
  }

  // 2.2 æ¸²æŸ“å·¦ä¾§åˆ—è¡¨
  const elList = document.getElementById('reportList');
  function renderList() {
    elList.innerHTML = '';
    
    let list = reports.filter(r => !r.is_deleted);
    if (currentCatFilter !== 'ALL') {
      list = list.filter(r => r.category === currentCatFilter);
    }

    // æœç´¢
    const key = document.getElementById('searchInput').value.trim().toLowerCase();
    if (key) {
      list = list.filter(r => {
        const c = getContent(r);
        return c && (c.project_name.toLowerCase().includes(key) || c.ticker.toLowerCase().includes(key));
      });
    }

    // æ’åº
    list.sort((a, b) => {
      if (currentSort === 'updated') return (b.last_updated_at||'').localeCompare(a.last_updated_at||'');
      const sa = getContent(a)?.ai_score?.overall || 0;
      const sb = getContent(b)?.ai_score?.overall || 0;
      return sb - sa;
    });

    list.forEach(r => {
      const c = getContent(r);
      if (!c) return;
      
      const div = document.createElement('div');
      div.className = `list-item ${r.id === currentReportId ? 'active' : ''}`;
      div.onclick = () => {
        currentReportId = r.id;
        isEditing = false;
        renderList(); // åˆ·æ–°é€‰ä¸­æ€
        renderDetail();
        document.getElementById('mainScroll').scrollTop = 0;
      };

      // åˆ†æ•°é¢œè‰²
      const score = c.ai_score?.overall || 0;
      let scoreClass = 'score-none';
      if (score >= 4.0) scoreClass = 'score-high';
      else if (score >= 3.0) scoreClass = 'score-mid';
      else if (score > 0) scoreClass = 'score-low';

      div.innerHTML = `
        <div class="item-main">
          <div class="item-title">${c.project_name}</div>
          <div class="item-meta">
            <span>${c.ticker || '-'}</span>
            <span>â€¢</span>
            <span>${r.last_updated_at?.slice(5, 10) || ''}</span>
          </div>
        </div>
        <div class="score-badge-mini ${scoreClass}">${score > 0 ? score.toFixed(1) : '-'}</div>
      `;
      elList.appendChild(div);
    });
    
    if (list.length === 0) {
      elList.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-dim);">æœªæ‰¾åˆ°é¡¹ç›®</div>';
    }
  }

  // 2.3 è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“é€šç”¨å†…å®¹åŒºå—
  function renderSection(title, contentHTML, editable, className = '') {
    // âš ï¸ è­¦å‘Šï¼šè¿™é‡Œä½¿ç”¨ innerHTML æ¸²æŸ“äº† AI ç”Ÿæˆçš„å†…å®¹ (contentHTML)ï¼Œå­˜åœ¨æ½œåœ¨ XSS é£é™©
    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”å¯¹ contentHTML è¿›è¡Œ DOMPurify ç­‰å®‰å…¨å¤„ç†ã€‚
    const editBtn = editable ? `<button class="btn edit-inline" onclick="toggleEdit()" title="ç¼–è¾‘å†…å®¹">âœï¸</button>` : '';
    return `
      <div class="content-section ${className}">
        <div class="section-title">
          ${title}
          ${editBtn}
        </div>
        <div class="content-text">
          ${contentHTML}
        </div>
      </div>
    `;
  }
  
  // 2.4 æ¸²æŸ“å³ä¾§è¯¦æƒ… (è¡¥å…¨å’Œä¿®å¤)
  const elDetail = document.getElementById('detailContainer');
  
  function renderDetail() {
    if (!currentReportId) {
      elDetail.innerHTML = `
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom:16px; opacity:0.2;">ğŸ“‚</div>
          <p>è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</p>
        </div>`;
      return;
    }

    const report = getReport(currentReportId);
    const c = getContent(report);
    
    if (!c) {
        elDetail.innerHTML = `
        <div class="empty-state">
            <div style="font-size: 48px; margin-bottom:16px; opacity:0.2;">âš ï¸</div>
            <p>é¡¹ç›®æ•°æ®ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥å¯¼å…¥çš„JSONæ ¼å¼æ˜¯å¦æ­£ç¡®æˆ–å†å²ç‰ˆæœ¬æ•°æ®ã€‚</p>
        </div>`;
        return;
    }

    if (isEditing) {
      renderEditMode(report, c);
      return;
    }

    // --- é¢œè‰²è¾…åŠ© ---
    const getScoreColor = (val) => {
      if (val >= 4.0) return 'var(--color-good)';
      if (val >= 3.0) return 'var(--color-mid)';
      return 'var(--color-bad)';
    };
    const scoreColor = getScoreColor(c.ai_score?.overall || 0);
    const scoreTextClass = (score) => {
      if (score >= 4.0) return 'score-high';
      else if (score >= 3.0) return 'score-mid';
      else if (score > 0) return 'score-low';
      return 'score-none';
    };

    let html = '';

    // --- 1. Hero Header ---
    html += `
      <div class="hero-header">
        <div class="hero-top-row">
          <h1 class="hero-title" style="color:${scoreColor}">AI æŠ¥å‘Š</h1>
          <div class="hero-actions">
            <button class="btn" onclick="toggleEdit()" title="ç¼–è¾‘æŠ¥å‘Š">âœï¸ ç¼–è¾‘</button>
            <button class="btn" onclick="openHistory()" title="å†å²ç‰ˆæœ¬">ğŸ”„ V${report.current_version}</button>
            <button class="btn" onclick="exportJSON()" title="å¯¼å‡ºJSON">â¬‡</button>
            <button class="btn pdf-download-btn" onclick="downloadPDF()" title="ä¸‹è½½PDFæŠ¥å‘Š">ğŸ“„ PDF</button>
            <button class="btn btn-icon-only" onclick="deleteReport()" title="åˆ é™¤" style="color:var(--color-bad);border-color:rgba(239,68,68,0.3);">ğŸ—‘</button>
          </div>
        </div>
        <h1 class="hero-title">
          ${c.project_name} 
          <span class="ticker-pill">${c.ticker || 'N/A'}</span>
        </h1>
        ${c.tagline ? `<div class="tagline-box">${c.tagline}</div>` : ''}
        <div class="hero-links">
          ${c.project_twitter && c.project_twitter !== 'æœªçŸ¥' ? `<a href="https://twitter.com/${c.project_twitter.replace('@','')}" target="_blank"><i class="fab fa-x-twitter"></i> X</a>` : ''}
          ${c.project_website && c.project_website !== 'æœªçŸ¥' ? `<a href="${c.project_website}" target="_blank"><i class="fas fa-globe"></i> Website</a>` : ''}
          <span class="launchpad-info"> 
            Launchpad: ${c.launchpad || 'æœªè®¾ç½®'} 
            <button class="btn-icon-only edit-inline" onclick="editLaunchpad()" title="ç¼–è¾‘Launchpad" style="margin-left: 4px; padding: 2px; font-size: 12px;">âœï¸</button>
          </span>
        </div>
      </div>
    `;

    // --- 2. é¡¹ç›®ç®€ä»‹ (æ”¾åœ¨ç¬¬ä¸€ä½) ---
    if (c.basic_info) {
      let txt = `<p>${c.basic_info.summary || 'æš‚æ— ç®€ä»‹'}</p>`;
      if (c.basic_info.core_features?.length) {
        txt += `<div class="feature-tags">${c.basic_info.core_features.map(x=>`<div class="feature-tag">${x}</div>`).join('')}</div>`;
      }
      html += renderSection('é¡¹ç›®ç®€ä»‹', txt, false, 'section-hero');
    }

    // --- 3. å½“ä¸‹é‡ç‚¹å…³æ³¨ (æ”¾åœ¨ç¬¬äºŒä½) ---
    if (c.focus_points && c.focus_points.length > 0) {
      html += `
        <div class="focus-card">
          <div class="focus-title">ğŸ”¥ å½“ä¸‹é‡ç‚¹å…³æ³¨</div>
          <ul class="focus-list">
            ${c.focus_points.map(p => `<li>${p}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    // --- 4. AI è¯„åˆ† (é›·è¾¾å›¾) ---
    if (c.ai_score) {
      const s = c.ai_score;
      html += `
        <div class="content-section ai-score-section" style="border-left: 4px solid ${scoreColor};">
          <div class="section-title">AI ç»¼åˆè¯„åˆ†: <span class="${scoreTextClass(s.overall)}" style="font-size:24px; padding: 0 8px; border-radius: 4px;">${(s.overall || 0).toFixed(1)}/5.0</span></div>
          <div class="radar-container">
            <canvas id="radarChart" class="radar-canvas"></canvas>
          </div>
          <div class="score-explanation">
            <strong>è¯„åˆ†è¯´æ˜:</strong> ${s.score_explanation || 'æš‚æ— è¯´æ˜'}
          </div>
          <div class="radar-legend">
              <div class="legend-item"><div class="legend-color" style="background:#38bdf8;"></div>åŸºç¡€ä¿¡æ¯: ${(s.base_info_reliability||0).toFixed(2)}</div>
              <div class="legend-item"><div class="legend-color" style="background:#22c55e;"></div>å™äº‹åŒ¹é…: ${(s.narrative_fit||0).toFixed(2)}</div>
              <div class="legend-item"><div class="legend-color" style="background:#eab308;"></div>äº§å“æŠ€æœ¯: ${(s.product_and_tech||0).toFixed(2)}</div>
              <div class="legend-item"><div class="legend-color" style="background:#a855f7;"></div>å›¢é˜Ÿå®åŠ›: ${(s.team_strength||0).toFixed(2)}</div>
              <div class="legend-item"><div class="legend-color" style="background:#ef4444;"></div>å¸‚åœºæ½œåŠ›: ${(s.market_potential||0).toFixed(2)}</div>
          </div>
        </div>
      `;
    }
    
    // --- 5. å…¶ä»–åŒºå— ---
    if (c.team) html += renderSection('å›¢é˜ŸèƒŒæ™¯', `<p>${c.team.description || 'æš‚æ— ä¿¡æ¯'}</p>`, false, 'section-team');
    
    if (c.tokenomics) html += renderSection('ä»£å¸ç»æµ', `<p>${c.tokenomics.description || 'æš‚æ— ä¿¡æ¯'}</p>`, false, 'section-tokenomics');

    if (c.business_potential) html += renderSection('å•†ä¸šæ½œåŠ›', `<p>${c.business_potential.analysis || 'æš‚æ— åˆ†æ'}</p>`, false, 'section-business');

    if (c.competitors) {
        let compHTML = `<p>${c.competitors.summary || 'æš‚æ— æ€»ç»“'}</p>`;
        if (c.competitors.main_competitors?.length) {
             compHTML += `<strong>ä¸»è¦ç«å“:</strong> <ul>${c.competitors.main_competitors.map(x=>`<li>${x}</li>`).join('')}</ul>`;
        }
        html += renderSection('ç«å“åˆ†æ', compHTML, false, 'section-competitors');
    }
    
    if (c.current_progress_and_roadmap) {
        html += renderSection('è¿›åº¦ä¸è·¯çº¿å›¾', `
            <p><strong>å½“å‰çŠ¶æ€:</strong> ${c.current_progress_and_roadmap.current_status || 'æœªçŸ¥'}</p>
            <p><strong>æœªæ¥è®¡åˆ’:</strong> ${c.current_progress_and_roadmap.future_plan || 'æœªçŸ¥'}</p>
        `, false);
    }
    
    // --- åº•éƒ¨ä¿¡æ¯ ---
    if (c.meta) {
      html += `
        <div style="margin-top: 40px; border-top: 1px dashed var(--border); padding-top: 20px; font-size: 13px; color: var(--text-dim);">
          æŠ¥å‘Šå…ƒæ•°æ®: <br/>
          æŠ¥å‘Šç‰ˆæœ¬: V${report.current_version} <br/>
          ç”Ÿæˆæ—¶é—´: ${c.meta.generated_at || '-'} <br/>
          ${c.meta.notes ? 'å¤‡æ³¨: '+c.meta.notes : ''}
        </div>
      `;
    }

    // âš ï¸ æ½œåœ¨ XSS é£é™©ï¼šæ­¤å¤„ç›´æ¥ä½¿ç”¨ innerHTML æ¸²æŸ“äº†åŒ…å«ç”¨æˆ·è¾“å…¥/AIè¾“å‡ºçš„ HTML å­—ç¬¦ä¸²
    elDetail.innerHTML = html;

    // æ¸²æŸ“é›·è¾¾å›¾
    if (c.ai_score) {
      // ä½¿ç”¨ setTimeout ç¡®ä¿ DOM å…ƒç´ æ¸²æŸ“å®Œæˆ
      setTimeout(() => { renderRadarChart(c.ai_score); }, 100);
    }
  }

  // é›·è¾¾å›¾æ¸²æŸ“å‡½æ•° - æ¢å¤ä¸ºç¨³å®šçš„é»˜è®¤å®ç°
  function renderRadarChart(scoreData) {
    const canvas = document.getElementById('radarChart');
    if (!canvas) return;

    // ç¡®ä¿ canvas åˆ†è¾¨ç‡ä¸æ˜¾ç¤ºå°ºå¯¸ä¸€è‡´
    const width = canvas.width = canvas.offsetWidth || 600;
    const height = canvas.height = canvas.offsetHeight || 300;
    const ctx = canvas.getContext('2d');

    const centerX = width / 2;
    const centerY = height / 2;
    const maxRadius = Math.min(width, height) * 0.35;
    const levels = 5;

    // äº”ä¸ªç»´åº¦åŠå…¶é¢œè‰²ï¼ˆä¿ç•™åŸå§‹é¢œè‰²æ˜ å°„ï¼Œä½†æ ‡ç­¾æ–‡å­—ä½¿ç”¨é»˜è®¤é¡µé¢æ–‡å­—è‰²ï¼‰
    const dimensions = [
      { name: 'åŸºç¡€ä¿¡æ¯', color: '#38bdf8', key: 'base_info_reliability' },
      { name: 'å™äº‹åŒ¹é…', color: '#22c55e', key: 'narrative_fit' },
      { name: 'äº§å“æŠ€æœ¯', color: '#eab308', key: 'product_and_tech' },
      { name: 'å›¢é˜Ÿå®åŠ›', color: '#a855f7', key: 'team_strength' },
      { name: 'å¸‚åœºæ½œåŠ›', color: '#ef4444', key: 'market_potential' }
    ];

    const values = dimensions.map(d => (scoreData && typeof scoreData[d.key] === 'number') ? scoreData[d.key] : 0);

    const axisCount = dimensions.length;
    const angleSlice = (Math.PI * 2) / axisCount;

    // æ¸…ç©ºç”»å¸ƒï¼ˆä¿æŒé€æ˜èƒŒæ™¯ä»¥å»åˆé¡µé¢ï¼‰
    ctx.clearRect(0, 0, width, height);

    // èƒŒæ™¯ç½‘æ ¼ï¼ˆåŒå¿ƒå¤šè¾¹å½¢ï¼‰
    ctx.strokeStyle = '#334155';
    ctx.lineWidth = 1;
    for (let lvl = levels; lvl >= 1; lvl--) {
      const r = (maxRadius * lvl) / levels;
      ctx.beginPath();
      for (let i = 0; i < axisCount; i++) {
        const angle = angleSlice * i - Math.PI / 2;
        const x = centerX + r * Math.cos(angle);
        const y = centerY + r * Math.sin(angle);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.stroke();
    }

    // è¾å°„çº¿
    ctx.strokeStyle = '#475569';
    for (let i = 0; i < axisCount; i++) {
      const angle = angleSlice * i - Math.PI / 2;
      const x = centerX + maxRadius * Math.cos(angle);
      const y = centerY + maxRadius * Math.sin(angle);
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    // æ•°æ®å¤šè¾¹å½¢
    ctx.beginPath();
    for (let i = 0; i < axisCount; i++) {
      const angle = angleSlice * i - Math.PI / 2;
      const r = Math.max(0, Math.min(1, values[i])) * maxRadius;
      const x = centerX + r * Math.cos(angle);
      const y = centerY + r * Math.sin(angle);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.closePath();
    ctx.fillStyle = 'rgba(56,189,248,0.12)';
    ctx.strokeStyle = '#38bdf8';
    ctx.lineWidth = 2;
    ctx.fill();
    ctx.stroke();

    // æ•°æ®ç‚¹ï¼ˆä½¿ç”¨å„è‡ªé¢œè‰²ï¼‰ & åˆ†æ•°ï¼ˆä½¿ç”¨å¯¹åº”é¢œè‰²ï¼‰
    for (let i = 0; i < axisCount; i++) {
      const angle = angleSlice * i - Math.PI / 2;
      const r = Math.max(0, Math.min(1, values[i])) * maxRadius;
      const x = centerX + r * Math.cos(angle);
      const y = centerY + r * Math.sin(angle);

      // èŠ‚ç‚¹ï¼šä½¿ç”¨ç»´åº¦é¢œè‰²å¡«å……å¹¶åŠ æè¾¹
      ctx.beginPath();
      ctx.fillStyle = dimensions[i].color;
      ctx.arc(x, y, 6, 0, Math.PI * 2);
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'rgba(0,0,0,0.15)';
      ctx.stroke();

      // åœ¨èŠ‚ç‚¹å¤–ä¾§æˆ–æ ‡ç­¾ä¸‹æ–¹æ˜¾ç¤ºåˆ†æ•°ï¼Œä½¿ç”¨åŒè‰²
      const scoreText = (values[i] || 0).toFixed(2);
      // è®¡ç®—æ ‡ç­¾ä½ç½®ï¼ˆä¸ç°æœ‰æ ‡ç­¾ä¿æŒä¸€è‡´ï¼‰
      const labelRadius = maxRadius + 28;
      const lx = centerX + labelRadius * Math.cos(angle);
      const ly = centerY + labelRadius * Math.sin(angle);

      // æ ‡ç­¾æ–‡å­—ï¼ˆç»´æŒé¡µé¢ä¸»è‰²ï¼‰
      ctx.font = '12px Arial';
      ctx.fillStyle = '#f1f5f9';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(dimensions[i].name, lx, ly);

      // åˆ†æ•°å­—ä½“ï¼šä½¿ç”¨ç»´åº¦é¢œè‰²
      ctx.font = '13px Arial';
      ctx.fillStyle = dimensions[i].color;
      ctx.fillText(scoreText, lx, ly + 16);
    }
  }

  // ç®€åŒ–çš„ renderEditMode è¡¥å…¨
  function renderEditMode(report, c) {
    const mkInput = (lbl, val, id) => `
      <div class="form-group">
        <label class="form-label">${lbl}</label>
        <input id="e_${id}" class="form-input" value="${(val||'').replace(/"/g, '&quot;')}" />
      </div>`;
    const mkText = (lbl, val, id) => `
      <div class="form-group">
        <label class="form-label">${lbl}</label>
        <textarea id="e_${id}" class="form-textarea">${(val||'')}</textarea>
      </div>`;
    
    // Launchpadä¿¡æ¯éœ€è¦å•ç‹¬å¤„ç†ï¼Œå› ä¸ºå®ƒä¸ä¸€å®šåœ¨å†…å®¹JSONçš„æ ¹éƒ¨
    const launchpadValue = c.launchpad || '';

    elDetail.innerHTML = `
      <div class="hero-header">
        <div class="hero-top-row">
          <h1 class="hero-title" style="font-size:24px;">ç¼–è¾‘æ¨¡å¼</h1>
          <div class="hero-actions">
            <button class="btn" onclick="toggleEdit()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveEdit()">ä¿å­˜ç‰ˆæœ¬</button>
          </div>
        </div>
        <div class="alert-box">ä¿®æ”¹åä¿å­˜å°†ç”Ÿæˆæ–°çš„å†å²ç‰ˆæœ¬ (V${Math.max(...report.versions.map(v=>v.version))+1})</div>
      </div>
      <div class="container-limit" style="max-width:800px;">
        <div class="edit-grid" style="grid-template-columns:1fr 1fr;">
          ${mkInput('é¡¹ç›®åç§°', c.project_name, 'pname')}
          ${mkInput('Ticker', c.ticker, 'ticker')}
          ${mkInput('å®˜ç½‘', c.project_website, 'web')}
          ${mkInput('X', c.project_twitter, 'tw')}
        </div>
        ${mkInput('Tagline (ä¸€å¥è¯æ ‡ç­¾)', c.tagline, 'tag')}
        ${mkInput('Launchpad', launchpadValue, 'launch')}
        
        <div style="margin:20px 0; border-top:1px solid var(--border);"></div>

        <h3 style="color:var(--text-muted)">AI è¯„åˆ† (0-1)</h3>
        <div class="edit-grid" style="grid-template-columns:1fr 1fr 1fr;">
          ${mkInput('æ€»åˆ† (0-5)', (c.ai_score?.overall || 0).toFixed(1), 's_all')}
          ${mkInput('åŸºç¡€ä¿¡æ¯ (0-1)', (c.ai_score?.base_info_reliability || 0).toFixed(2), 's_base')}
          ${mkInput('å™äº‹ (0-1)', (c.ai_score?.narrative_fit || 0).toFixed(2), 's_narr')}
          ${mkInput('äº§å“ (0-1)', (c.ai_score?.product_and_tech || 0).toFixed(2), 's_prod')}
          ${mkInput('å›¢é˜Ÿ (0-1)', (c.ai_score?.team_strength || 0).toFixed(2), 's_team')}
          ${mkInput('å¸‚åœº (0-1)', (c.ai_score?.market_potential || 0).toFixed(2), 's_mkt')}
        </div>
        ${mkText('è¯„åˆ†è§£é‡Š', c.ai_score?.score_explanation, 's_exp')}
        
        <div style="margin:20px 0; border-top:1px solid var(--border);"></div>
        
        <h3 style="color:var(--text-muted)">å†…å®¹è¯¦æƒ…</h3>
        ${mkText('é¡¹ç›®ç®€ä»‹ (Summary)', c.basic_info?.summary, 'info_sum')}
        ${mkInput('æ ¸å¿ƒç‰¹æ€§ (ç”¨é€—å·åˆ†éš”)', c.basic_info?.core_features?.join(', '), 'info_feat')}
        ${mkText('å½“ä¸‹é‡ç‚¹å…³æ³¨ (ä¸€è¡Œä¸€é¡¹)', c.focus_points?.join('\n'), 'focus')}
        ${mkText('å›¢é˜ŸèƒŒæ™¯', c.team?.description, 'team_desc')}
        ${mkText('ä»£å¸ç»æµ', c.tokenomics?.description, 'token_desc')}
        ${mkText('å•†ä¸šæ½œåŠ›åˆ†æ', c.business_potential?.analysis, 'biz_an')}
        
      </div>
    `;
  }

  function saveEdit() {
    const report = getReport(currentReportId);
    const oldC = getContent(report);
    const nextVer = Math.max(...report.versions.map(v=>v.version)) + 1;
    
    // æ”¶é›†æ–°æ•°æ® (ä½¿ç”¨æ—§æ•°æ®ä½œä¸ºåŸºå‡†ï¼Œç¡®ä¿ç»“æ„å®Œæ•´)
    const newC = JSON.parse(JSON.stringify(oldC));
    
    // æ ¹çº§å±æ€§
    newC.project_name = document.getElementById('e_pname').value.trim();
    newC.ticker = document.getElementById('e_ticker').value.trim();
    newC.tagline = document.getElementById('e_tag').value.trim();
    newC.project_website = document.getElementById('e_web').value.trim();
    newC.project_twitter = document.getElementById('e_tw').value.trim();
    newC.launchpad = document.getElementById('e_launch').value.trim();
    
    // è¯„åˆ†
    newC.ai_score = newC.ai_score || {};
    newC.ai_score.overall = parseFloat(document.getElementById('e_s_all').value) || 0;
    newC.ai_score.base_info_reliability = parseFloat(document.getElementById('e_s_base').value) || 0;
    newC.ai_score.narrative_fit = parseFloat(document.getElementById('e_s_narr').value) || 0;
    newC.ai_score.product_and_tech = parseFloat(document.getElementById('e_s_prod').value) || 0;
    newC.ai_score.team_strength = parseFloat(document.getElementById('e_s_team').value) || 0;
    newC.ai_score.market_potential = parseFloat(document.getElementById('e_s_mkt').value) || 0;
    newC.ai_score.score_explanation = document.getElementById('e_s_exp').value.trim();

    // è¯¦æƒ…å†…å®¹
    newC.basic_info = newC.basic_info || {};
    newC.basic_info.summary = document.getElementById('e_info_sum').value.trim();
    const coreFeaturesStr = document.getElementById('e_info_feat').value.trim();
    newC.basic_info.core_features = coreFeaturesStr ? coreFeaturesStr.split(',').map(s=>s.trim()).filter(s=>s) : [];

    const focusStr = document.getElementById('e_focus').value.trim();
    newC.focus_points = focusStr ? focusStr.split('\n').map(s=>s.trim()).filter(s=>s) : [];

    newC.team = newC.team || {};
    newC.team.description = document.getElementById('e_team_desc').value.trim();
    
    newC.tokenomics = newC.tokenomics || {};
    newC.tokenomics.description = document.getElementById('e_token_desc').value.trim();

    newC.business_potential = newC.business_potential || {};
    newC.business_potential.analysis = document.getElementById('e_biz_an').value.trim();
    
    // ä¿å­˜æ–°ç‰ˆæœ¬
    const now = new Date().toISOString();
    report.versions.push({
      version: nextVer,
      created_at: now,
      source: 'manual_edit',
      content: newC
    });
    report.current_version = nextVer;
    report.last_updated_at = now;
    
    saveData();
    isEditing = false;
    renderList();
    renderDetail();
  }

  // ============================================
  // 4. Launchpad ç¼–è¾‘ & 5. åˆ†ç±»ç®¡ç† 
  // ============================================
  function editLaunchpad() {
    const report = getReport(currentReportId);
    const c = getContent(report);
    document.getElementById('launchpadInput').value = c.launchpad || '';
    openModal('modalLaunchpad');
  } 

  function saveLaunchpad() {
    const report = getReport(currentReportId);
    const c = getContent(report);
    
    // ç¡®ä¿ Launchpad æ›´æ–°åˆ°å½“å‰ç‰ˆæœ¬çš„ content ä¸­
    c.launchpad = document.getElementById('launchpadInput').value.trim(); 
    report.last_updated_at = new Date().toISOString();
    saveData();
    closeModal('modalLaunchpad');
    renderDetail();
  } 

  function openCategoryManage() {
    renderCategoryList();
    openModal('modalCategoryManage');
  } 

  function renderCategoryList() {
    const container = document.getElementById('categoryList');
    container.innerHTML = '';
    const sorted = [...categories].sort((a,b)=>{
      if (a.id==='qita' && b.id!=='qita') return 1;
      if (b.id==='qita' && a.id!=='qita') return -1;
      return String(a.name).localeCompare(String(b.name));
    });
    sorted.forEach((cat) => {
      const projectCount = reports.filter(r => r.category === cat.id && !r.is_deleted).length;
      const div = document.createElement('div');
      div.className = 'list-item';
      div.style.marginBottom = '8px';
      const actionZone = document.createElement('div');
      actionZone.style.display = 'flex';
      actionZone.style.gap = '4px';
      const left = document.createElement('div');
      left.style.flex = '1';
      left.innerHTML = `<div style="font-weight:500;">${cat.name}</div>
        <div style="font-size:11px;color:var(--text-dim);margin-top:4px;">é¡¹ç›®æ•°: ${projectCount}</div>`;
      const editBtn = document.createElement('button');
      editBtn.className = 'btn-icon-only edit-inline';
      editBtn.title = 'ç¼–è¾‘';
      editBtn.style.fontSize = '12px';
      editBtn.textContent = 'âœï¸';
      editBtn.onclick = () => editCategory(categories.findIndex(c=>c.id===cat.id));
      actionZone.appendChild(editBtn);
      if (cat.id !== 'qita' && cat.id !== 'ALL'){
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-icon-only edit-inline';
        delBtn.title = 'åˆ é™¤';
        delBtn.style.fontSize = '12px';
        delBtn.style.color = 'var(--color-bad)';
        delBtn.textContent = 'ğŸ—‘';
        delBtn.onclick = () => deleteCategory(categories.findIndex(c=>c.id===cat.id));
        actionZone.appendChild(delBtn);
      }
      div.appendChild(left);
      div.appendChild(actionZone);
      container.appendChild(div);
    });
  } 
  
  async function addNewCategory() {
    const name = document.getElementById('newCategoryName').value.trim();
    if (!name) return alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
    const r = await api('/api/categories','POST',{ name });
    if (!r.ok){ alert((r.body&&r.body.error)||'åˆ›å»ºå¤±è´¥'); return; }
    document.getElementById('newCategoryName').value = '';
    await loadData();
    renderCategoryList();
    renderTabs();
  } 
  
  function editCategory(index) {
    const newName = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:', categories[index].name);
    if (newName && newName.trim()) {
      categories[index].name = newName.trim();
      saveCats();
      renderCategoryList();
      renderTabs();
    }
  } 
  
  async function deleteCategory(index) {
    const cat = categories[index];
    if (!cat) return;
    if (!confirm(`ç¡®å®šåˆ é™¤åˆ†ç±» "${cat.name}" å—ï¼Ÿè¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰é¡¹ç›®å°†ç§»è‡³ "å…¶ä»–" åˆ†ç±»ã€‚`)) return;
    const r = await api(`/api/categories?id=${encodeURIComponent(cat.id)}`,'DELETE');
    if (!r.ok){ alert((r.body&&r.body.error)||'åˆ é™¤å¤±è´¥'); return; }
    // æœ¬åœ°è§†å›¾ç«‹å³è¿ç§»ä»¥æå‡ç”¨æˆ·ä½“éªŒ
    reports.forEach(x=>{ if (x.category===cat.id) x.category='qita'; });
    await loadData();
    currentCatFilter = 'ALL';
    renderCategoryList();
    renderTabs();
    renderList();
  }


  // ============================================
  // 6. å¯¼å…¥/å¯¼å‡ºé€»è¾‘
  // ============================================

  // ç”Ÿæˆ Prompt çš„å†…å®¹æ›´æ–°å‡½æ•° - ä¿®æ”¹ä¸ºæ–°è¯„åˆ†æ¨¡å‹
  function updatePrompt() {
    const name = document.getElementById('pName').value.trim();
    const ticker = document.getElementById('pTicker').value.trim();
    const web = document.getElementById('pWeb').value.trim();
    const tw = document.getElementById('pTw').value.trim();
    const note = document.getElementById('pNote').value.trim();

    if (!name || !ticker) {
      document.getElementById('pMsg').textContent = 'é¡¹ç›®åç§°å’ŒTickerä¸ºå¿…å¡«é¡¹ï¼';
      document.getElementById('pMsg').style.color = 'var(--color-bad)';
      document.getElementById('pOutput').value = '';
      return;
    }
    document.getElementById('pMsg').textContent = '';

    let prompt = `è¯·åˆ†æä»¥ä¸‹é¡¹ç›®ï¼Œå¹¶ä»¥JSONæ ¼å¼è¾“å‡ºæŠ•ç ”æŠ¥å‘Šï¼š
é¡¹ç›®åç§°: ${name}
Ticker/ä»£å¸ç¬¦å·: ${ticker}`;
    
    if (web) prompt += `\nå®˜ç½‘: ${web}`;
    if (tw) prompt += `\nX: ${tw}`;
    if (note) prompt += `\nè¡¥å……èµ„æ–™/å¤‡æ³¨: ${note}`;
    
    // æ’å…¥ JSON æ¨¡æ¿ï¼Œç¡®ä¿ AI è¾“å‡ºæ ¼å¼æ­£ç¡® - æ›´æ–°ä¸ºæ–°è¯„åˆ†æ¨¡å‹
    prompt += `\n
[ä»¥ä¸‹æ˜¯JSONæŠ¥å‘Šæ ¼å¼è¦æ±‚ï¼Œè¯·ä¸¥æ ¼éµå¾ª]
{
  "project_name": "${name}", // é¡¹ç›®åç§°
  "ticker": "${ticker}",     // Ticker/ä»£å¸ç¬¦å·
  "focus_points": [ "ä»ä»£å¸æŠ•èµ„è§†è§’å‡ºå‘ï¼Œå½“ä¸‹æœ€éœ€è¦é‡ç‚¹å…³æ³¨çš„è¦ç‚¹ï¼Œ1 æ¡ä¸€é¡¹ï¼Œå»ºè®® 3-7 æ¡", "â€¦â€¦" ], 
  "ai_score": { 
    "overall": 0.0, // æ€»åˆ†ï¼ŒèŒƒå›´0-5.0ï¼Œç­‰äºä»¥ä¸‹5ä¸ªç»´åº¦ç›¸åŠ 
    "base_info_reliability": 0.0, // åŸºç¡€ä¿¡æ¯å¯é æ€§ï¼šè¯„ä¼°é¡¹ç›®åŸºæœ¬ä¿¡æ¯çš„å¯ä¿¡åº¦å’Œå®Œæ•´æ€§ï¼ŒèŒƒå›´0-1.0
    "narrative_fit": 0.0, // å™äº‹åŒ¹é…åº¦ï¼šè¯„ä¼°é¡¹ç›®å™äº‹ä¸å¸‚åœºè¶‹åŠ¿å’Œéœ€æ±‚çš„åŒ¹é…ç¨‹åº¦ï¼ŒèŒƒå›´0-1.0
    "product_and_tech": 0.0, // äº§å“æŠ€æœ¯ï¼šè¯„ä¼°é¡¹ç›®çš„æŠ€æœ¯å®åŠ›å’Œäº§å“å®ç°èƒ½åŠ›ï¼ŒèŒƒå›´0-1.0
    "team_strength": 0.0, // å›¢é˜Ÿå®åŠ›ï¼šè¯„ä¼°å›¢é˜Ÿçš„èƒŒæ™¯ã€ç»éªŒå’Œæ‰§è¡ŒåŠ›ï¼ŒèŒƒå›´0-1.0
    "market_potential": 0.0, // å¸‚åœºæ½œåŠ›ï¼šè¯„ä¼°é¡¹ç›®æ‰€åœ¨å¸‚åœºçš„è§„æ¨¡ã€å¢é•¿å’Œç«äº‰æ ¼å±€ï¼ŒèŒƒå›´0-1.0
    "score_explanation": "ç”¨å‡ å¥è¯è§£é‡Šæ‰“åˆ†çš„æ ¸å¿ƒé€»è¾‘ï¼Œè¯´æ˜æ€»åˆ†æ˜¯å¦‚ä½•ç”±å„ç»´åº¦ç›¸åŠ å¾—å‡ºçš„" 
  },
  "launchpad": "å­—ç¬¦ä¸²ï¼Œlaunchpad å¹³å°ï¼Œå¦‚ä¿¡æ¯ä¸è¶³è¯·å¡« 'ä¿¡æ¯ä¸è¶³ï¼ˆéœ€äººå·¥è¡¥å……ï¼‰'", 
  "tagline": "æ ‡ç­¾ï¼šä¸€å¥è¯çŸ­å¥ï¼Œæ¦‚æ‹¬é¡¹ç›®çš„æ ¸å¿ƒå®šä½ï¼Œä¾‹å¦‚ï¼š'é¢å‘ DeFi çš„ AI é£æ§åŸºç¡€è®¾æ–½'ã€‚å¦‚ä¿¡æ¯ä¸è¶³ï¼Œè¯·å†™ 'ä¿¡æ¯ä¸è¶³'ã€‚", 
  "basic_info": { 
    "summary": "é¡¹ç›®ä»‹ç»çš„æ•´ä½“æ¦‚è¿°ï¼Œ1-2 æ®µã€‚", 
    "core_features": [ "æ ¸å¿ƒç‰¹ç‚¹ 1", "æ ¸å¿ƒç‰¹ç‚¹ 2" ] 
  }, 
  "team": { 
    "description": "å›¢é˜ŸèƒŒæ™¯æ€»ç»“ã€‚", 
    "is_ai_inferred": false 
  }, 
  "tokenomics": { 
    "description": "ä»£å¸æœºåˆ¶/åŠŸèƒ½ä»‹ç»ï¼Œå¦‚ä¿¡æ¯ä¸è¶³åˆ™è¯´æ˜ 'ä¿¡æ¯ä¸è¶³'ã€‚", 
    "is_ai_inferred": false 
  }, 
  "business_potential": { 
    "analysis": "ä»å•†ä¸šè½åœ°å’Œç›ˆåˆ©æ¨¡å¼è§’åº¦çš„åˆ†æã€‚", 
    "is_ai_inferred": false 
  }, 
  "competitors": { 
    "summary": "ç«å“ç®€ä»‹", 
    "main_competitors": [ "ç«å“é¡¹ç›®åç§° 1ï¼ˆå¦‚æœ‰ï¼‰" ], 
    "is_ai_inferred": false 
  }, 
  "current_progress_and_roadmap": {
    "current_status": "å½“å‰çŠ¶æ€",
    "future_plan": "æœªæ¥è®¡åˆ’"
  },
  "meta": {
    "generated_at": "${new Date().toISOString()}",
    "source_url": "",
    "notes": "ç”¨æˆ·å¤‡æ³¨: ${note}"
  }
}

è¯„åˆ†æ¨¡å‹è¯´æ˜ï¼š
- æ¯ä¸ªç»´åº¦è¯„åˆ†èŒƒå›´ï¼š0-1.0åˆ†
- æ€»åˆ†è®¡ç®—ï¼šå„ç»´åº¦åˆ†æ•°ç›¸åŠ ï¼ŒèŒƒå›´0-5.0åˆ†
- è¯„åˆ†æ ‡å‡†ï¼š
  - 0.8-1.0åˆ†ï¼šä¼˜ç§€ - åœ¨è¯¥ç»´åº¦è¡¨ç°çªå‡º
  - 0.6-0.7åˆ†ï¼šè‰¯å¥½ - åœ¨è¯¥ç»´åº¦è¡¨ç°è¾ƒå¥½
  - 0.4-0.5åˆ†ï¼šä¸€èˆ¬ - åœ¨è¯¥ç»´åº¦è¡¨ç°ä¸€èˆ¬
  - 0.2-0.3åˆ†ï¼šè¾ƒå·® - åœ¨è¯¥ç»´åº¦è¡¨ç°ä¸è¶³
  - 0.0-0.1åˆ†ï¼šå·® - åœ¨è¯¥ç»´åº¦è¡¨ç°ä¸¥é‡ä¸è¶³

å„ç»´åº¦è¯¦ç»†è¯„ä¼°å†…å®¹ï¼š
- åŸºç¡€ä¿¡æ¯å¯é æ€§ï¼šè¯„ä¼°é¡¹ç›®åŸºæœ¬ä¿¡æ¯çš„å¯ä¿¡åº¦å’Œå®Œæ•´æ€§ï¼ŒåŒ…æ‹¬å®˜ç½‘ã€ç™½çš®ä¹¦ã€æŠ€æœ¯æ–‡æ¡£ã€å›¢é˜Ÿä¿¡æ¯ç­‰
- å™äº‹åŒ¹é…åº¦ï¼šè¯„ä¼°é¡¹ç›®å™äº‹ä¸å¸‚åœºè¶‹åŠ¿å’Œéœ€æ±‚çš„åŒ¹é…ç¨‹åº¦ï¼ŒåŒ…æ‹¬æ˜¯å¦å¥‘åˆå½“å‰è¡Œä¸šçƒ­ç‚¹ã€é—®é¢˜è§£å†³èƒ½åŠ›ã€å·®å¼‚åŒ–å®šä½ç­‰
- äº§å“æŠ€æœ¯ï¼šè¯„ä¼°é¡¹ç›®çš„æŠ€æœ¯å®åŠ›å’Œäº§å“å®ç°èƒ½åŠ›ï¼ŒåŒ…æ‹¬æŠ€æœ¯åˆ›æ–°æ€§ã€äº§å“æˆç†Ÿåº¦ã€æŠ€æœ¯å¯è¡Œæ€§ã€å¼€å‘è¿›åº¦ã€å®‰å…¨æ€§èƒ½ç­‰
- å›¢é˜Ÿå®åŠ›ï¼šè¯„ä¼°å›¢é˜Ÿçš„èƒŒæ™¯ã€ç»éªŒå’Œæ‰§è¡ŒåŠ›ï¼ŒåŒ…æ‹¬è¡Œä¸šç»éªŒã€æŠ€æœ¯èƒŒæ™¯ã€è¿‡å¾€æˆå°±ã€ç»„ç»‡èƒ½åŠ›ã€ç¤¾åŒºå½±å“ç­‰
- å¸‚åœºæ½œåŠ›ï¼šè¯„ä¼°é¡¹ç›®æ‰€åœ¨å¸‚åœºçš„è§„æ¨¡ã€å¢é•¿å’Œç«äº‰æ ¼å±€ï¼ŒåŒ…æ‹¬å¸‚åœºè§„æ¨¡ã€å¢é•¿è¶‹åŠ¿ã€ç«äº‰åˆ†æã€å•†ä¸šæ¨¡å¼ã€ç”¨æˆ·åŸºç¡€ç­‰
`;
    
    document.getElementById('pOutput').value = prompt;
  }

  // è§£æå¯¼å…¥çš„ JSON æŠ¥å‘Š
  function parseImport() {
    const text = document.getElementById('importText').value.trim();
    document.getElementById('importMsg').textContent = '';
    pendingImportData = null;

    try {
      const data = JSON.parse(text);
      if (!data.project_name || !data.ticker) {
        throw new Error('JSONç¼ºå°‘ project_name æˆ– ticker å­—æ®µã€‚');
      }
      pendingImportData = data;
      
      // æ¸²æŸ“åˆ†ç±»é€‰æ‹©
      const catSelect = document.getElementById('catSelect');
      catSelect.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('') + 
                            '<option value="__NEW__">--- åˆ›å»ºæ–°åˆ†ç±» ---</option>';
      
      // è®¾ç½®æ–°åˆ†ç±»è¾“å…¥æ¡†åˆå§‹çŠ¶æ€
      document.getElementById('newCatGroup').style.display = 'none';

      closeModal('modalImport');
      openModal('modalCategory');

    } catch (e) {
      document.getElementById('importMsg').textContent = 'JSONè§£æé”™è¯¯æˆ–æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼š' + e.message;
      document.getElementById('importMsg').style.color = 'var(--color-bad)';
    }
  }

  // ç¡®è®¤ä¿å­˜å¯¼å…¥çš„æŠ¥å‘Š
  function confirmImport() {
    if (!pendingImportData) return;
    
    const catSelect = document.getElementById('catSelect');
    let categoryId = catSelect.value;
    let categoryName = catSelect.options[catSelect.selectedIndex].text;

    if (categoryId === '__NEW__') {
      categoryName = document.getElementById('newCatInput').value.trim();
      if (!categoryName) {
        alert('è¯·è¾“å…¥æ–°åˆ†ç±»åç§°');
        return;
      }
      categoryId = categoryName.replace(/\s+/g, '_').toUpperCase();
      if (categories.find(c => c.id === categoryId)) {
          alert('åˆ†ç±»å·²å­˜åœ¨');
          return;
      }
      categories.push({ id: categoryId, name: categoryName });
      saveCats();
    }

    // æ„å»ºæ–°æŠ¥å‘Šå¯¹è±¡
    const now = new Date().toISOString();
    const newReport = {
      id: genId(),
      category: categoryId,
      created_at: now,
      last_updated_at: now,
      is_deleted: false,
      current_version: 1,
      versions: [{
        version: 1,
        created_at: now,
        source: 'manual_import',
        content: pendingImportData
      }]
    };

    reports.unshift(newReport); // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
    saveData();
    
    // åˆ·æ–°UI
    currentReportId = newReport.id;
    currentCatFilter = categoryId; // åˆ‡æ¢åˆ°æ–°å¯¼å…¥çš„åˆ†ç±»
    renderTabs();
    renderList();
    renderDetail();
    
    // æ¸…ç†
    pendingImportData = null;
    document.getElementById('importText').value = '';
    closeModal('modalCategory');
    closeModal('modalImport');
  }

  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('importText').value = e.target.result;
      document.getElementById('importMsg').textContent = 'æ–‡ä»¶è¯»å–æˆåŠŸï¼Œè¯·ç‚¹å‡»"è§£æå¹¶ä¸‹ä¸€æ­¥"';
      document.getElementById('importMsg').style.color = 'var(--color-good)';
    };
    reader.onerror = function() {
      document.getElementById('importMsg').textContent = 'æ–‡ä»¶è¯»å–å¤±è´¥';
      document.getElementById('importMsg').style.color = 'var(--color-bad)';
    };
    reader.readAsText(file);
  }

  // æ‹–æ‹½åŠŸèƒ½
  window.handleDrop = function(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      if (files.length > 0) {
          const file = files[0];
          if (file.name.endsWith('.json')) {
              // æ¨¡æ‹Ÿæ–‡ä»¶è¾“å…¥é€‰æ‹©ï¼Œè§¦å‘ onchange äº‹ä»¶
              document.getElementById('jsonFileInput').files = files;
              document.getElementById('jsonFileInput').dispatchEvent(new Event('change'));
          } else {
              document.getElementById('importMsg').textContent = 'è¯·æ‹–æ”¾JSONæ ¼å¼çš„æ–‡ä»¶';
              document.getElementById('importMsg').style.color = 'var(--color-bad)';
          }
      }
  };
  
  // ============================================
  // 7. å†å²ç‰ˆæœ¬ä¸å¯¼å‡º
  // ============================================

  window.deleteReport = () => {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤æŠ¥å‘Šå—ï¼Ÿ')) return;
    const r = getReport(currentReportId);
    r.is_deleted = true;
    saveData();
    currentReportId = null;
    renderList();
    renderDetail();
  };

  window.openHistory = () => {
    const r = getReport(currentReportId);
    document.getElementById('historyList').innerHTML = r.versions.map(v => `
      <div class="list-item" style="justify-content:space-between; margin-bottom: 8px;">
        <div>
          <div style="font-weight: 500;">ç‰ˆæœ¬ V${v.version}</div>
          <div style="font-size:12px; color:var(--text-dim); margin-top: 4px;">æ¥æº: ${v.source}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:12px; color:var(--text-dim);">${v.created_at.slice(0,16).replace('T',' ')}</div>
          <button class="btn edit-inline" onclick="restoreVersion(${v.version})" ${v.version === r.current_version ? 'disabled' : ''} style="margin-top: 4px;">
            ${v.version === r.current_version ? 'å½“å‰ç‰ˆæœ¬' : 'æ¢å¤ç‰ˆæœ¬'}
          </button>
        </div>
      </div>
    `).join('');
    openModal('modalHistory');
  };

  window.restoreVersion = (ver) => {
   
    const r = getReport(currentReportId);
    r.current_version = ver;
    r.last_updated_at = new Date().toISOString();
    saveData();
    closeModal('modalHistory');
    renderDetail();
    renderList(); // æ›´æ–°æ—¶é—´
  };

  window.exportJSON = () => {
    const r = getReport(currentReportId);
    const c = getContent(r);
    const blob = new Blob([JSON.stringify(c, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${c.project_name}_report.json`;
    a.click();
  };
  
  // ============================================
  // 8. PDFä¸‹è½½åŠŸèƒ½ (ä¼˜åŒ–ä¸ºä½¿ç”¨ html2canvas + jspdf)
  // ============================================

  function downloadPDF() {
    if (!currentReportId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®');
        return;
    }

    const detailContent = document.getElementById('detailContainer');
    // å…‹éš†è¯¦æƒ…å®¹å™¨ï¼Œç”¨äºæ¸²æŸ“åˆ° PDF çš„ä¸´æ—¶ç¯å¢ƒ
    const pdfContainer = detailContent.cloneNode(true);
    
    // ç§»é™¤è¯¦æƒ…å®¹å™¨ä¸­çš„æ‰€æœ‰æŒ‰é’®ï¼Œç¡®ä¿PDFå¹²å‡€
    pdfContainer.querySelectorAll('.hero-actions, .edit-inline').forEach(el => el.remove());
    pdfContainer.querySelector('.launchpad-info button')?.remove();

    // ä¸´æ—¶æ·»åŠ åˆ° DOM å¤–éƒ¨è¿›è¡Œæ¸²æŸ“
    pdfContainer.id = 'pdf-temp-container';
    pdfContainer.style.maxWidth = '900px';
    pdfContainer.style.margin = '0 auto';
    pdfContainer.style.padding = '30px';
    pdfContainer.style.background = '#ffffff'; // PDFèƒŒæ™¯è®¾ä¸ºç™½è‰²
    pdfContainer.style.color = '#333';
    // è°ƒæ•´é¢œè‰²ä»¥é€‚åº”ç™½è‰²èƒŒæ™¯
    pdfContainer.querySelectorAll('.content-text p, .content-text li').forEach(el => el.style.color = '#333');
    pdfContainer.querySelectorAll('.section-title').forEach(el => el.style.color = '#000');
    pdfContainer.querySelectorAll('.score-explanation').forEach(el => {
      el.style.background = '#f0f9ff';
      el.style.border = '1px solid #bae6fd';
    });
    pdfContainer.querySelectorAll('.content-section').forEach(el => {
      el.style.background = '#f7f7f7';
      el.style.border = '1px solid #e0e0e0';
    });
    pdfContainer.querySelectorAll('.hero-title').forEach(el => el.style.color = '#000');


    document.body.appendChild(pdfContainer);

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4'); // A4 å°ºå¯¸
    const margin = 10;
    const pageWidth = pdf.internal.pageSize.getWidth() - 2 * margin; // é¡µé¢å®½åº¦ï¼Œç•™å‡ºè¾¹è·

    // å¼ºåˆ¶Canvasæ¸²æŸ“é›·è¾¾å›¾
    const canvasElement = pdfContainer.querySelector('#radarChart');
    if (canvasElement) {
        // ç”±äºæ˜¯cloneNodeï¼Œéœ€è¦é‡æ–°æ¸²æŸ“é›·è¾¾å›¾åˆ°å…‹éš†çš„canvasä¸Š
        const report = getReport(currentReportId);
        // ä½¿ç”¨å…‹éš†çš„ canvas å…ƒç´ è¿›è¡Œæ¸²æŸ“
        renderRadarChartToTarget(canvasElement, getContent(report)?.ai_score || {});
    }

    // é’ˆå¯¹å…‹éš†å‡ºçš„canvasæ¸²æŸ“çš„è¾…åŠ©å‡½æ•° - é€‚é…æ–°è¯„åˆ†æ¨¡å‹
    function renderRadarChartToTarget(canvas, scoreData) {
        // ç”±äº renderRadarChart æ˜¯ä¸€ä¸ªå¤æ‚å‡½æ•°ï¼Œä¸ºäº†ç®€åŒ–ï¼Œç›´æ¥åœ¨å…‹éš†èŠ‚ç‚¹ä¸Šè°ƒç”¨æ¸²æŸ“é€»è¾‘
        // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç®€åŒ–å¤„ç†ï¼Œå¦‚æœé›·è¾¾å›¾ä¾èµ–å…¨å±€ Canvas çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´.
        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = canvas.offsetHeight;
        const centerX = width / 2;
        const centerY = height / 2;
        const radius = Math.min(width, height) * 0.38; // å¢å¤§åŠå¾„

        // å¤åˆ¶åŸ renderRadarChart é€»è¾‘åˆ°è¿™é‡Œï¼Œä½¿ç”¨ç™½è‰²èƒŒæ™¯é€‚é… PDF
        ctx.clearRect(0, 0, width, height);
        
        const dimensions = [
          { key: 'base_info_reliability', label: 'åŸºç¡€ä¿¡æ¯', color: '#38bdf8' },
          { key: 'narrative_fit', label: 'å™äº‹åŒ¹é…', color: '#22c55e' },
          { key: 'product_and_tech', label: 'äº§å“æŠ€æœ¯', color: '#eab308' },
          { key: 'team_strength', label: 'å›¢é˜Ÿå®åŠ›', color: '#a855f7' },
          { key: 'market_potential', label: 'å¸‚åœºæ½œåŠ›', color: '#ef4444' }
        ];
        const scores = dimensions.map(d => (scoreData[d.key] || 0)); // 0-1 èŒƒå›´
        const scoreLabels = dimensions.map(d => (scoreData[d.key] || 0).toFixed(2));
        
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.12)'; // é»‘è‰²ç½‘æ ¼çº¿ï¼ˆæ›´è½»ï¼‰
        ctx.lineWidth = 1;
        
        for (let i = 1; i <= 5; i++) {
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius * (i / 5), 0, Math.PI * 2);
          ctx.stroke();
        }

        dimensions.forEach((dim, i) => {
          const angle = (Math.PI * 2 * i / dimensions.length) - Math.PI / 2;
          const x = centerX + Math.cos(angle) * radius;
          const y = centerY + Math.sin(angle) * radius;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.lineTo(x, y);
          ctx.stroke();
          
          ctx.fillStyle = '#333'; // é»‘è‰²æ ‡ç­¾
          ctx.font = '14px Arial'; // å¢å¤§å­—ä½“
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          const labelX = centerX + Math.cos(angle) * (radius + 25); // å¢åŠ è·ç¦»
          const labelY = centerY + Math.sin(angle) * (radius + 25);
          ctx.fillText(dim.label, labelX, labelY);
        });

        // ç»˜åˆ¶æ•°æ®åŒºåŸŸ
        ctx.beginPath();
        ctx.strokeStyle = 'rgba(56, 189, 248, 0.8)';
        ctx.fillStyle = 'rgba(56, 189, 248, 0.3)';
        ctx.lineWidth = 2;

        dimensions.forEach((dim, i) => {
          const score = scores[i] || 0; 
          const angle = (Math.PI * 2 * i / dimensions.length) - Math.PI / 2;
          const pointRadius = radius * score;
          const x = centerX + Math.cos(angle) * pointRadius;
          const y = centerY + Math.sin(angle) * pointRadius;

          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });

        ctx.closePath();
        ctx.stroke();
        ctx.fill();

        // èŠ‚ç‚¹ä¸åˆ†æ•°ä½¿ç”¨å¯¹åº”é¢œè‰²
        dimensions.forEach((dim, i) => {
          const score = scores[i] || 0;
          const angle = (Math.PI * 2 * i / dimensions.length) - Math.PI / 2;
          const pointRadius = radius * score;
          const x = centerX + Math.cos(angle) * pointRadius;
          const y = centerY + Math.sin(angle) * pointRadius;

          // èŠ‚ç‚¹
          ctx.fillStyle = dim.color;
          ctx.beginPath();
          ctx.arc(x, y, 7, 0, Math.PI * 2); // å¢å¤§ç‚¹çš„å°ºå¯¸
          ctx.fill();
          ctx.strokeStyle = 'rgba(0,0,0,0.12)';
          ctx.lineWidth = 1;
          ctx.stroke();

          // åˆ†æ•°ï¼ˆä½¿ç”¨å¯¹åº”é¢œè‰²ï¼Œé»‘è‰²æè¾¹ä½¿å…¶åœ¨ç™½åº•ä¸Šæ›´æ¸…æ™°ï¼‰
          ctx.fillStyle = dim.color;
          ctx.font = '12px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(scoreLabels[i], x, y - 16); // è°ƒæ•´åˆ†æ•°ä½ç½®
        });
    }

    html2canvas(pdfContainer, {
        allowTaint: true,
        useCORS: true,
        scale: 2, // æé«˜åˆ†è¾¨ç‡
        backgroundColor: '#ffffff'
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = pageWidth;
        const pageHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = pageHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, pageHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();

        while (heightLeft >= 0) {
            position = heightLeft - pageHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', margin, position + margin, imgWidth, pageHeight);
            heightLeft -= pdf.internal.pageSize.getHeight();
        }

        const reportName = getContent(getReport(currentReportId))?.project_name || 'AI_Report';
        pdf.save(`${reportName}_Report.pdf`);

        // æ¸…ç†ä¸´æ—¶ DOM èŠ‚ç‚¹
        document.body.removeChild(pdfContainer);

        // é‡æ–°æ¸²æŸ“åŸå§‹é›·è¾¾å›¾ï¼Œä¿®å¤å…‹éš†å¯¹åŸé¡µé¢çš„å½±å“
        renderRadarChart(getContent(getReport(currentReportId))?.ai_score || {});
    });
  }

  // ============================================
  // 9. åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š
  // ============================================

  function init() {
    loadData();
    // ç¡®ä¿ reports ä¸ä¸ºç©ºï¼Œå¦åˆ™ currentReportId å¯èƒ½ä»ä¸º null
    if (reports.length > 0) {
      // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªæœªåˆ é™¤çš„é¡¹ç›®
      currentReportId = reports.find(r => !r.is_deleted)?.id || null;
    }
    
    // åˆå§‹åŒ–è§†å›¾
    renderTabs();
    renderList();
    renderDetail();
  }

  // äº‹ä»¶ç»‘å®š
  document.getElementById('navBtnPrompt').onclick = () => openModal('modalPrompt');
  document.getElementById('navBtnImport').onclick = () => openModal('modalImport');
  
  // Prompt æ¨¡æ€æ¡†
  document.getElementById('pName').oninput = updatePrompt;
  document.getElementById('pTicker').oninput = updatePrompt;
  document.getElementById('pWeb').oninput = updatePrompt;
  document.getElementById('pTw').oninput = updatePrompt;
  document.getElementById('pNote').oninput = updatePrompt;
  document.getElementById('btnGenPrompt').onclick = () => {
    updatePrompt();
    // å¤åˆ¶é€»è¾‘
    const output = document.getElementById('pOutput');
    output.select();
    output.setSelectionRange(0, 99999);
    // å…¼å®¹æ€§æ›´å¥½çš„å¤åˆ¶æ–¹å¼
    try {
        document.execCommand('copy');
        document.getElementById('pMsg').textContent = 'Promptå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼';
        document.getElementById('pMsg').style.color = 'var(--color-good)';
    } catch (err) {
        document.getElementById('pMsg').textContent = 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚';
        document.getElementById('pMsg').style.color = 'var(--color-bad)';
    }
  };

  // å¯¼å…¥æ¨¡æ€æ¡†
  document.getElementById('btnImportParse').onclick = parseImport;
  document.getElementById('btnConfirmImport').onclick = confirmImport;
  document.getElementById('catSelect').onchange = (e) => {
    document.getElementById('newCatGroup').style.display = e.target.value === '__NEW__' ? 'block' : 'none';
  };

  // æœç´¢å’Œæ’åº
  document.getElementById('searchInput').oninput = debounce(renderList, 300);
  document.getElementById('sortSelect').onchange = (e) => {
    currentSort = e.target.value;
    renderList();
  };

  // æ‹–æ‹½æ–‡ä»¶äº‹ä»¶ç›‘å¬ (åŸç‰ˆä»£ç çš„è¡¥å……)
  const fileUploadArea = document.getElementById('fileUploadArea');
  if (fileUploadArea) {
      fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
      fileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadArea.classList.remove('dragover'); });
      fileUploadArea.addEventListener('drop', (e) => { 
        e.preventDefault(); 
        fileUploadArea.classList.remove('dragover');
        window.handleDrop(e);
      });
  }
    
  // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
  window.onload = init;
</script>
</script>
<script>
  async function api(path, method, data){ const opts = { method: method||'GET', headers:{ 'Content-Type':'application/json' } }; if (data) opts.body = JSON.stringify(data); const resp = await fetch(path, opts); const ct = resp.headers.get('Content-Type')||''; const body = ct.includes('application/json')? await resp.json() : await resp.text(); return { ok: resp.ok, body }; }
  async function loadData(){ const cats = await api('/api/categories'); categories = (cats.ok && cats.body && cats.body.items) ? cats.body.items.map(c=>({ id:c.id, name:c.name })) : []; const r = await api('/api/reports?page=1&page_size=200&sort=recent'); const items = (r.ok && r.body && r.body.items) ? r.body.items : []; reports = items.map(it=>({ id: it.id, category: it.category, created_at: it.created_at, last_updated_at: it.updated_at, is_deleted: !!it.deleted_at, current_version: 1, versions: [{ version:1, created_at: it.created_at, source:'backend', content: (it.content || { project_name: it.project_name||'', ticker: it.ticker||'', launchpad: it.launchpad||'', basic_info: it.basic_info? { summary: it.basic_info } : {}, ai_score: {} }) }] })); }
  function saveData(){ }
  function saveCats(){ }
  function getReport(id){ return reports.find(r=>r.id===id); }
  function getContent(report){ return report && report.versions && report.versions[0] ? report.versions[0].content : null; }
  async function addNewCategory(){ const name = document.getElementById('newCategoryName').value.trim(); if (!name) { alert('è¯·è¾“å…¥åˆ†ç±»åç§°'); return; } const r = await api('/api/categories','POST',{ name }); if (!r.ok){ alert((r.body&&r.body.error)||'åˆ›å»ºå¤±è´¥'); return; } document.getElementById('newCategoryName').value=''; await loadData(); renderCategoryList(); renderTabs(); }
  async function deleteCategory(index){ const cat = categories[index]; if (!cat) return; if (cat.id==='qita'){ alert('â€œå…¶ä»–â€ä¸å¯åˆ é™¤'); return; } if (!confirm(`ç¡®å®šåˆ é™¤åˆ†ç±» "${cat.name}" å—ï¼Ÿç›¸å…³é¡¹ç›®å°†ç§»è‡³ "å…¶ä»–" åˆ†ç±»ã€‚`)) return; const r = await api(`/api/categories?id=${encodeURIComponent(cat.id)}`,'DELETE'); if (!r.ok){ alert((r.body&&r.body.error)||'åˆ é™¤å¤±è´¥'); return; } await loadData(); currentCatFilter='ALL'; renderCategoryList(); renderTabs(); renderList(); }
  async function confirmImport(){ if (!pendingImportData) return; const catSelect = document.getElementById('catSelect'); let categoryId = catSelect.value; let categoryName = catSelect.options[catSelect.selectedIndex].text; if (categoryId==='__NEW__'){ categoryName = document.getElementById('newCatInput').value.trim(); if (!categoryName){ alert('è¯·è¾“å…¥æ–°åˆ†ç±»åç§°'); return; } const cr = await api('/api/categories','POST',{ name: categoryName }); if (!cr.ok){ alert((cr.body&&cr.body.error)||'åˆ†ç±»åˆ›å»ºå¤±è´¥'); return; } categoryId = (cr.body && cr.body.id) || categoryName.toLowerCase().replace(/\s+/g,'_'); }
    const norm = normalizeContent(pendingImportData);
    const payload = { project_name: norm.project_name || pendingImportData.project_name, category: categoryId, content: norm, ticker: norm.ticker, launchpad: norm.launchpad };
    const pr = await api('/api/reports','POST', payload); if (!pr.ok){ alert((pr.body&&pr.body.error)||'ä¿å­˜å¤±è´¥'); return; }
    await loadData(); currentReportId = pr.body && pr.body.id; currentCatFilter = categoryId; renderTabs(); renderList(); renderDetail(); pendingImportData=null; document.getElementById('importText').value=''; closeModal('modalCategory'); closeModal('modalImport'); }
  async function saveEdit(){ const report = getReport(currentReportId); const oldC = getContent(report); const newC = JSON.parse(JSON.stringify(oldC)); newC.project_name = document.getElementById('e_pname').value.trim(); newC.ticker = document.getElementById('e_ticker').value.trim(); newC.tagline = document.getElementById('e_tag').value.trim(); newC.project_website = document.getElementById('e_web').value.trim(); newC.project_twitter = document.getElementById('e_tw').value.trim(); newC.launchpad = document.getElementById('e_launch').value.trim(); newC.ai_score = newC.ai_score || {}; newC.ai_score.overall = parseFloat(document.getElementById('e_s_all').value)||0; newC.ai_score.base_info_reliability = parseFloat(document.getElementById('e_s_base').value)||0; newC.ai_score.narrative_fit = parseFloat(document.getElementById('e_s_narr').value)||0; newC.ai_score.product_and_tech = parseFloat(document.getElementById('e_s_prod').value)||0; newC.ai_score.team_strength = parseFloat(document.getElementById('e_s_team').value)||0; newC.ai_score.market_potential = parseFloat(document.getElementById('e_s_mkt').value)||0; newC.ai_score.score_explanation = document.getElementById('e_s_exp').value.trim(); newC.basic_info = newC.basic_info || {}; newC.basic_info.summary = document.getElementById('e_info_sum').value.trim(); const coreFeaturesStr = document.getElementById('e_info_feat').value.trim(); newC.basic_info.core_features = coreFeaturesStr ? coreFeaturesStr.split(',').map(s=>s.trim()).filter(s=>s) : []; const focusStr = document.getElementById('e_focus').value.trim(); newC.focus_points = focusStr ? focusStr.split('\n').map(s=>s.trim()).filter(s=>s) : []; newC.team = newC.team || {}; newC.team.description = document.getElementById('e_team_desc').value.trim(); newC.tokenomics = newC.tokenomics || {}; newC.tokenomics.description = document.getElementById('e_token_desc').value.trim(); newC.business_potential = newC.business_potential || {}; newC.business_potential.analysis = document.getElementById('e_biz_an').value.trim(); const r = await api(`/api/reports?id=${encodeURIComponent(currentReportId)}`,'PUT',{ content: newC }); if (!r.ok){ alert((r.body&&r.body.error)||'æ›´æ–°å¤±è´¥'); return; } isEditing=false; await loadData(); renderTabs(); renderList(); renderDetail(); }
  async function deleteReport(){ if (!confirm('ç¡®å®šåˆ é™¤æ­¤æŠ¥å‘Šå—ï¼Ÿ')) return; const r = await api(`/api/reports?id=${encodeURIComponent(currentReportId)}`,'DELETE'); if (!r.ok){ alert((r.body&&r.body.error)||'åˆ é™¤å¤±è´¥'); return; } currentReportId=null; await loadData(); renderTabs(); renderList(); renderDetail(); }
  async function openHistory(){ const r = await api(`/api/reports?id=${encodeURIComponent(currentReportId)}&last_edit=1`); const item = (r.ok && r.body) ? r.body : null; const list = document.getElementById('historyList'); if (!item){ list.innerHTML = '<div class="list-item" style="justify-content:center">æš‚æ— å†å²å¿«ç…§</div>'; } else { const ts = item.edited_at ? item.edited_at.slice(0,16).replace('T',' ') : ''; list.innerHTML = `<div class="list-item" style="justify-content:space-between; margin-bottom:8px"><div><div style="font-weight:500;">æœ€è¿‘å¿«ç…§</div><div style="font-size:12px; color:var(--text-dim); margin-top:4px;">${ts}</div></div><div style="text-align:right;"><button class="btn" onclick="restoreVersion(0)">æ¢å¤</button></div></div>`; } openModal('modalHistory'); }
  async function restoreVersion(ver){ const r = await api(`/api/reports?id=${encodeURIComponent(currentReportId)}&restore=1`,'POST'); if (!r.ok){ alert((r.body&&r.body.error)||'æ¢å¤å¤±è´¥'); return; } closeModal('modalHistory'); await loadData(); renderDetail(); renderList(); }
  const _init = init; init = async function(){ await loadData(); if (reports.length>0){ currentReportId = reports.find(r=>!r.is_deleted)?.id || null; } renderTabs(); renderList(); renderDetail(); };

  function normalizeContent(src){
    const out = JSON.parse(JSON.stringify(src||{}));
    // æ ¹çº§å­—æ®µ
    out.project_name = out.project_name || out.projectName || '';
    out.ticker = out.ticker || '';
    out.launchpad = out.launchpad || out.launchpad_platform || '';
    // basic_info
    if (typeof out.basic_info === 'string'){
      out.basic_info = { summary: out.basic_info, core_features: [] };
    } else {
      out.basic_info = out.basic_info || { summary:'', core_features: [] };
      out.basic_info.summary = out.basic_info.summary || '';
      out.basic_info.core_features = Array.isArray(out.basic_info.core_features)? out.basic_info.core_features : [];
    }
    // team
    if (!out.team || typeof out.team !== 'object') out.team = { description:'' };
    out.team.description = out.team.description || '';
    // tokenomics
    if (!out.tokenomics || typeof out.tokenomics !== 'object') out.tokenomics = { description:'' };
    out.tokenomics.description = out.tokenomics.description || '';
    // business_potential
    if (!out.business_potential || typeof out.business_potential !== 'object') out.business_potential = { analysis:'' };
    out.business_potential.analysis = out.business_potential.analysis || '';
    // competitors
    if (!out.competitors || typeof out.competitors !== 'object') out.competitors = { summary:'', main_competitors: [] };
    out.competitors.summary = out.competitors.summary || '';
    out.competitors.main_competitors = Array.isArray(out.competitors.main_competitors)? out.competitors.main_competitors : [];
    // focus_points
    out.focus_points = Array.isArray(out.focus_points)? out.focus_points : [];
    // ai_score
    const s = out.ai_score || {}; out.ai_score = {
      overall: parseFloat(s.overall)||0,
      base_info_reliability: parseFloat(s.base_info_reliability)||0,
      narrative_fit: parseFloat(s.narrative_fit)||0,
      product_and_tech: parseFloat(s.product_and_tech)||0,
      team_strength: parseFloat(s.team_strength)||0,
      market_potential: parseFloat(s.market_potential)||0,
      score_explanation: s.score_explanation || ''
    };
    // meta
    out.meta = out.meta || { generated_at: new Date().toISOString(), source_url:'', notes:'' };
    return out;
  }

  async function ensureCategoryByName(name){ const list = await api('/api/categories'); const items = (list.ok && list.body && list.body.items) ? list.body.items : []; const hit = items.find(c => String(c.name) === String(name)); if (hit) return hit.id; const cr = await api('/api/categories','POST',{ name }); if (cr.ok && cr.body && cr.body.id) return cr.body.id; return (name||'').toLowerCase().replace(/\s+/g,'_') || 'qita'; }
  async function migrateFromLocal(){ try{ const flag = localStorage.getItem('local_migrated_v1'); if (flag==='1') return; const rs = localStorage.getItem(KEY_REPORTS); const cs = localStorage.getItem(KEY_CATS); if (!rs && !cs){ localStorage.setItem('local_migrated_v1','1'); return; } let catList = []; if (cs){ try{ const parsedC = JSON.parse(cs); catList = Array.isArray(parsedC) ? parsedC : (parsedC.categories||[]); }catch(e){} } const nameMap = {}; for (const c of catList){ const nm = c && c.name ? c.name : (c.id||''); if (!nm) continue; nameMap[nm] = await ensureCategoryByName(nm); }
    const reportsRaw = rs ? JSON.parse(rs) : []; for (const r of Array.isArray(reportsRaw)?reportsRaw:[]){ if (r && r.is_deleted) continue; const c = (r && r.versions && r.versions[0] && r.versions[0].content) ? r.versions[0].content : null; if (!c) continue; const norm = normalizeContent(c); let catId = r.category || 'qita'; if (catId === 'å…¶ä»–') catId = 'qita'; if (!/^[a-z0-9_]+$/.test(catId)) { const nm = catList.find(x=>x.id===r.category||x.name===r.category)?.name || r.category; catId = nameMap[nm] || (String(nm||'qita').toLowerCase().replace(/\s+/g,'_')); }
      await api('/api/reports','POST',{ project_name: norm.project_name || r.project_name || 'è¿ç§»æŠ¥å‘Š', category: catId, content: norm, ticker: norm.ticker, launchpad: norm.launchpad }); }
    localStorage.setItem('local_migrated_v1','1'); localStorage.removeItem(KEY_REPORTS); localStorage.removeItem(KEY_CATS);
  }catch(e){ localStorage.setItem('local_migrated_v1','1'); }
  const __orig_init = init; init = async function(){ await migrateFromLocal(); await loadData(); if (reports.length>0){ currentReportId = reports.find(r=>!r.is_deleted)?.id || null; } renderTabs(); renderList(); renderDetail(); };
</script>
</body>
</html>
